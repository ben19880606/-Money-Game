name: Send Loan Notifications via LINE

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  send-notifications:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install supabase python-dotenv requests
      
      - name: Send LINE notifications
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_CHANNEL_SECRET: ${{ secrets.LINE_CHANNEL_SECRET }}
        run: |
          python << 'EOF'
          import os
          import json
          from datetime import datetime, timedelta
          import requests
          from supabase import create_client, Client
          
          SUPABASE_URL = os.environ.get("SUPABASE_URL")
          SUPABASE_KEY = os.environ.get("SUPABASE_SERVICE_ROLE_KEY")
          LINE_CHANNEL_ACCESS_TOKEN = os.environ.get("LINE_CHANNEL_ACCESS_TOKEN")
          
          supabase = create_client(SUPABASE_URL, SUPABASE_KEY)
          LINE_API_ENDPOINT = "https://api.line.me/v2/bot/message/push"
          
          print("ðŸ”„ å¼€å§‹æ£€æŸ¥æ–°å€Ÿæ¬¾...")
          
          try:
              # èŽ·å–æ–°å€Ÿæ¬¾
              one_hour_ago = (datetime.utcnow() - timedelta(hours=1)).isoformat()
              response = supabase.table("loan_requests").select(
                  "id, title, amount, description, city, borrower_id, created_at"
              ).eq("status", "pending").gte("created_at", one_hour_ago).execute()
              
              loans = response.data if response.data else []
              print(f"ðŸ“‹ æ‰¾åˆ° {len(loans)} ç¬”æ–°å€Ÿæ¬¾")
              
              if not loans:
                  print("âœ… æ²¡æœ‰æ–°å€Ÿæ¬¾ï¼Œä»»åŠ¡å®Œæˆ")
              else:
                  # èŽ·å–é‡‘ä¸»ä¼šå‘˜
                  lender_response = supabase.table("profiles").select(
                      "id, line_id, line_user_id, membership_type"
                  ).in_("membership_type", ["lender", "æ——è‰¦", "å°Šæ¦®", "é‰‘é‡‘"]).execute()
                  
                  lenders = lender_response.data if lender_response.data else []
                  print(f"ðŸ‘¥ æ‰¾åˆ° {len(lenders)} ä¸ªé‡‘ä¸»ä¼šå‘˜")
                  
                  notification_count = 0
                  for loan in loans:
                      for lender in lenders:
                          line_id = lender.get("line_user_id") or lender.get("line_id")
                          if line_id:
                              message = {
                                  "to": line_id,
                                  "messages": [{
                                      "type": "text",
                                      "text": f"ã€å®‰å¿ƒå€Ÿè²¸ç¶² | æ–°å€Ÿæ¬¾æ¡ˆä»¶ã€‘\n\næ¡ˆä»¶ç·¨è™Ÿï¼šLR{loan['id']}\nå€Ÿæ¬¾é‡‘é¡ï¼š${loan['amount']:,}\nåœ°å€ï¼š{loan['city']}\nç”¨é€”ï¼š{loan['description']}"
                                  }]
                              }
                              
                              headers = {
                                  "Authorization": f"Bearer {LINE_CHANNEL_ACCESS_TOKEN}",
                                  "Content-Type": "application/json"
                              }
                              
                              response = requests.post(LINE_API_ENDPOINT, json=message, headers=headers)
                              if response.status_code == 200:
                                  print(f"âœ… é€šçŸ¥å·²å‘é€ç»™ {line_id}")
                                  notification_count += 1
                  
                  print(f"âœ… ä»»åŠ¡å®Œæˆ! å‘é€äº† {notification_count} æ¡é€šçŸ¥")
          
          except Exception as e:
              print(f"âŒ é”™è¯¯: {e}")
              exit(1)
          EOF
