name: Send Loan Notifications via LINE

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  send-notifications:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Send LINE notifications
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_CHANNEL_SECRET: ${{ secrets.LINE_CHANNEL_SECRET }}
        run: |
          python << 'EOF'
          import os
          import json
          import time
          from datetime import datetime, timedelta
          import requests
          from supabase import create_client, Client
          
          SUPABASE_URL = os.environ.get("SUPABASE_URL")
          SUPABASE_KEY = os.environ.get("SUPABASE_SERVICE_ROLE_KEY")
          LINE_CHANNEL_ACCESS_TOKEN = os.environ.get("LINE_CHANNEL_ACCESS_TOKEN")
          
          # È©óË≠âÂøÖÈúÄÁöÑÁí∞Â¢ÉËÆäÈáè
          if not SUPABASE_URL or not SUPABASE_KEY:
              print("‚ùå ÈåØË™§: Áº∫Â∞ë Supabase ÈÖçÁΩÆ")
              exit(1)
          
          if not LINE_CHANNEL_ACCESS_TOKEN:
              print("‚ùå ÈåØË™§: Áº∫Â∞ë LINE Channel Access Token")
              exit(1)
          
          supabase = create_client(SUPABASE_URL, SUPABASE_KEY)
          LINE_API_ENDPOINT = "https://api.line.me/v2/bot/message/push"
          
          # ÈáçË©¶ÈÖçÁΩÆ
          MAX_RETRIES = 3
          RETRY_DELAY = 2  # Áßí
          
          def send_notification_with_retry(line_id, message, max_retries=MAX_RETRIES):
              """Â∏∂ÈáçË©¶Ê©üÂà∂ÁöÑÈÄöÁü•ÁôºÈÄÅ"""
              headers = {
                  "Authorization": f"Bearer {LINE_CHANNEL_ACCESS_TOKEN}",
                  "Content-Type": "application/json"
              }
              
              for attempt in range(max_retries):
                  try:
                      response = requests.post(
                          LINE_API_ENDPOINT, 
                          json=message, 
                          headers=headers,
                          timeout=10
                      )
                      
                      if response.status_code == 200:
                          return True, None
                      elif response.status_code == 429:
                          # ÈÄüÁéáÈôêÂà∂ÔºåÁ≠âÂæÖÊõ¥Èï∑ÊôÇÈñì
                          time.sleep(RETRY_DELAY * (attempt + 1) * 2)
                          continue
                      else:
                          error_msg = f"HTTP {response.status_code}: {response.text}"
                          if attempt < max_retries - 1:
                              time.sleep(RETRY_DELAY * (attempt + 1))
                              continue
                          return False, error_msg
                  except requests.exceptions.Timeout:
                      if attempt < max_retries - 1:
                          time.sleep(RETRY_DELAY * (attempt + 1))
                          continue
                      return False, "Ë´ãÊ±ÇË∂ÖÊôÇ"
                  except Exception as e:
                      if attempt < max_retries - 1:
                          time.sleep(RETRY_DELAY * (attempt + 1))
                          continue
                      return False, str(e)
              
              return False, "ÈÅîÂà∞ÊúÄÂ§ßÈáçË©¶Ê¨°Êï∏"
          
          print("üîÑ ÈñãÂßãÊ™¢Êü•Êñ∞ÂÄüÊ¨æ...")
          
          try:
              # Áç≤ÂèñÊñ∞ÂÄüÊ¨æ
              one_hour_ago = (datetime.utcnow() - timedelta(hours=1)).isoformat()
              response = supabase.table("loan_requests").select(
                  "id, title, amount, description, city, borrower_id, created_at"
              ).eq("status", "pending").gte("created_at", one_hour_ago).execute()
              
              loans = response.data if response.data else []
              print(f"üìã ÊâæÂà∞ {len(loans)} Á≠ÜÊñ∞ÂÄüÊ¨æ")
              
              if not loans:
                  print("‚úÖ Ê≤íÊúâÊñ∞ÂÄüÊ¨æÔºå‰ªªÂãôÂÆåÊàê")
                  exit(0)
              
              # Áç≤ÂèñÂ∑≤È©óË≠âÊîØ‰ªòÁöÑÈáë‰∏ªÊúÉÂì°
              lender_response = supabase.table("profiles").select(
                  "id, line_id, line_user_id, membership_type, membership_tier"
              ).eq(
                  "membership_type", "lender"
              ).eq(
                  "payment_verified", "YES"
              ).execute()
              
              lenders = lender_response.data if lender_response.data else []
              print(f"üë• ÊâæÂà∞ {len(lenders)} ÂÄãÂ∑≤ÊøÄÊ¥ªÁöÑÈáë‰∏ªÊúÉÂì°")
              
              if not lenders:
                  print("‚ö†Ô∏è  Ê≤íÊúâÂ∑≤ÊøÄÊ¥ªÁöÑÈáë‰∏ªÊúÉÂì°")
                  exit(0)
              
              notification_count = 0
              failed_count = 0
              
              for loan in loans:
                  for lender in lenders:
                      line_id = lender.get("line_user_id") or lender.get("line_id")
                      if not line_id:
                          continue
                      
                      message = {
                          "to": line_id,
                          "messages": [{
                              "type": "text",
                              "text": f"„ÄêÂÆâÂøÉÂÄüË≤∏Á∂≤ | Êñ∞ÂÄüÊ¨æÊ°à‰ª∂„Äë\n\nÊ°à‰ª∂Á∑®ËôüÔºöLR{loan['id']}\nÂÄüÊ¨æÈáëÈ°çÔºö${loan['amount']:,}\nÂú∞ÂçÄÔºö{loan.get('city', 'Êú™ÊåáÂÆö')}\nÁî®ÈÄîÔºö{loan.get('description', 'Êú™Êèê‰æõ')}\n\nÊü•ÁúãË©≥ÊÉÖÔºöhttps://axnihao.com/loan/{loan['id']}"
                          }]
                      }
                      
                      success, error = send_notification_with_retry(line_id, message)
                      
                      if success:
                          print(f"‚úÖ ÈÄöÁü•Â∑≤ÁôºÈÄÅÁµ¶ {line_id}")
                          notification_count += 1
                          
                          # Ë®òÈåÑÈÄöÁü•
                          try:
                              supabase.table("lender_interactions").insert({
                                  "lender_id": lender["id"],
                                  "request_id": loan["id"],
                                  "interaction_type": "notification_sent",
                                  "interaction_date": datetime.utcnow().isoformat()
                              }).execute()
                          except Exception as e:
                              print(f"‚ö†Ô∏è  Ë®òÈåÑÈÄöÁü•Â§±Êïó: {e}")
                      else:
                          print(f"‚ùå ÁôºÈÄÅÂ§±ÊïóÁµ¶ {line_id}: {error}")
                          failed_count += 1
                      
                      # ÈÅøÂÖçÈÄüÁéáÈôêÂà∂
                      time.sleep(0.1)
              
              print(f"\n‚úÖ ‰ªªÂãôÂÆåÊàê!")
              print(f"   ÊàêÂäüÁôºÈÄÅ: {notification_count} Ê¢ùÈÄöÁü•")
              if failed_count > 0:
                  print(f"   ÁôºÈÄÅÂ§±Êïó: {failed_count} Ê¢ùÈÄöÁü•")
              
              # Â¶ÇÊûúÂ§±ÊïóÁéáÈÅéÈ´òÔºåËøîÂõûÈåØË™§
              if failed_count > notification_count:
                  print("‚ö†Ô∏è  Ë≠¶Âëä: Â§±ÊïóÈÄöÁü•Êï∏ÈáèË∂ÖÈÅéÊàêÂäüÊï∏Èáè")
                  exit(1)
          
          except Exception as e:
              print(f"‚ùå ÈåØË™§: {e}")
              import traceback
              traceback.print_exc()
              exit(1)
          EOF
      
      - name: Send alert on failure
        if: failure()
        env:
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}
        run: |
          python << 'EOF'
          import os
          import smtplib
          from email.mime.text import MIMEText
          from datetime import datetime
          
          try:
              smtp_user = os.environ.get("SMTP_USERNAME")
              smtp_pass = os.environ.get("SMTP_PASSWORD")
              alert_email = os.environ.get("ALERT_EMAIL", "aijinetwork@gmail.com")
              
              if not smtp_user or not smtp_pass:
                  print("‚ö†Ô∏è  ÈÉµ‰ª∂ÈÖçÁΩÆÊú™Ë®≠ÁΩÆÔºåË∑≥ÈÅéÁôºÈÄÅÂëäË≠¶")
                  exit(0)
              
              msg = MIMEText(f'ÂÄüÊ¨æÈÄöÁü•Â∑•‰ΩúÊµÅÂü∑Ë°åÂ§±ÊïóÔºÅ\n\nÊôÇÈñìÔºö{datetime.now().strftime("%Y-%m-%d %H:%M:%S")}\n\nË´ãÊ™¢Êü• GitHub Actions Êó•Ë™å„ÄÇ')
              msg['Subject'] = '‚ùå [Money-Game] ÂÄüÊ¨æÈÄöÁü•Â§±Êïó'
              msg['From'] = smtp_user
              msg['To'] = alert_email
              
              with smtplib.SMTP_SSL('smtp.gmail.com', 465) as server:
                  server.login(smtp_user, smtp_pass)
                  server.send_message(msg)
              
              print("‚úÖ ÂëäË≠¶ÈÉµ‰ª∂Â∑≤ÁôºÈÄÅ")
          except Exception as e:
              print(f"‚ö†Ô∏è  ÁôºÈÄÅÂëäË≠¶Â§±Êïó: {e}")
          EOF
