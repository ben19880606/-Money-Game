name: Payment Auto-Activation

on:
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  activate-members:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Verify pending payments
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          python << 'EOF'
          import os
          from datetime import datetime
          from supabase import create_client, Client
          
          SUPABASE_URL = os.environ.get("SUPABASE_URL")
          SUPABASE_KEY = os.environ.get("SUPABASE_SERVICE_ROLE_KEY")
          
          supabase = create_client(SUPABASE_URL, SUPABASE_KEY)
          
          print("ðŸ”„ é–‹å§‹æª¢æŸ¥å¾…æ¿€æ´»çš„é‡‘ä¸»æœƒå“¡...")
          
          try:
              # æŸ¥è©¢æ‰€æœ‰æœªé©—è­‰æ”¯ä»˜ä½†å·²å¡«å¯«åŒ¯æ¬¾è³‡è¨Šçš„é‡‘ä¸»
              response = supabase.table("profiles").select(
                  "id, email, membership_type, membership_tier, payment_last_five_digits"
              ).eq(
                  "membership_type", "lender"
              ).eq(
                  "payment_verified", "NO"
              ).not_.is_(
                  "payment_last_five_digits", "null"
              ).execute()
              
              pending_members = response.data if response.data else []
              
              print(f"ðŸ“‹ æ‰¾åˆ° {len(pending_members)} å€‹å¾…æ¿€æ´»çš„é‡‘ä¸»æœƒå“¡")
              
              if not pending_members:
                  print("âœ… æ²’æœ‰å¾…æ¿€æ´»çš„æœƒå“¡")
                  exit(0)
              
              # è‡ªå‹•æ¿€æ´»æœƒå“¡
              activated_count = 0
              for member in pending_members:
                  member_id = member["id"]
                  email = member.get("email", "æœªçŸ¥")
                  
                  # æ›´æ–°æœƒå“¡ç‹€æ…‹
                  update_result = supabase.table("profiles").update({
                      "payment_verified": "YES",
                      "activated_at": datetime.utcnow().isoformat()
                  }).eq("id", member_id).execute()
                  
                  if update_result.data:
                      print(f"âœ… å·²æ¿€æ´»æœƒå“¡: {email} (ID: {member_id})")
                      activated_count += 1
                  else:
                      print(f"âŒ æ¿€æ´»å¤±æ•—: {email} (ID: {member_id})")
              
              print(f"\nâœ… ä»»å‹™å®Œæˆ! æˆåŠŸæ¿€æ´» {activated_count} å€‹æœƒå“¡")
              
          except Exception as e:
              print(f"âŒ éŒ¯èª¤: {e}")
              exit(1)
          EOF
      
      - name: Send activation report
        if: always()
        env:
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}
        run: |
          python << 'EOF'
          import os
          import smtplib
          from email.mime.text import MIMEText
          from email.mime.multipart import MIMEMultipart
          from datetime import datetime
          
          try:
              smtp_user = os.environ.get("SMTP_USERNAME")
              smtp_pass = os.environ.get("SMTP_PASSWORD")
              alert_email = os.environ.get("ALERT_EMAIL", "aijinetwork@gmail.com")
              
              if not smtp_user or not smtp_pass:
                  print("âš ï¸  éƒµä»¶é…ç½®æœªè¨­ç½®ï¼Œè·³éŽç™¼é€å ±å‘Š")
                  exit(0)
              
              msg = MIMEMultipart()
              msg['Subject'] = '[Money-Game] é‡‘ä¸»æœƒå“¡è‡ªå‹•æ¿€æ´»å ±å‘Š'
              msg['From'] = smtp_user
              msg['To'] = alert_email
              
              body = f"""
              ã€é‡‘ä¸»æœƒå“¡è‡ªå‹•æ¿€æ´»å ±å‘Šã€‘
              
              åŸ·è¡Œæ™‚é–“ï¼š{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
              
              æœ¬æ¬¡è‡ªå‹•æ¿€æ´»ä»»å‹™å·²å®Œæˆã€‚
              è«‹æŸ¥çœ‹ä¸Šæ–¹æ—¥èªŒäº†è§£è©³ç´°ä¿¡æ¯ã€‚
              
              ---
              Money-Game è‡ªå‹•åŒ–ç³»çµ±
              """
              
              msg.attach(MIMEText(body, 'plain', 'utf-8'))
              
              with smtplib.SMTP_SSL('smtp.gmail.com', 465) as server:
                  server.login(smtp_user, smtp_pass)
                  server.send_message(msg)
              
              print("âœ… æ¿€æ´»å ±å‘Šå·²ç™¼é€")
          except Exception as e:
              print(f"âš ï¸  ç™¼é€å ±å‘Šå¤±æ•—: {e}")
          EOF
