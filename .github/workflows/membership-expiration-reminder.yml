name: Membership Expiration Reminder

on:
  schedule:
    # Run daily at 9:00 AM UTC to check for expiring memberships
    - cron: '0 9 * * *'
  workflow_dispatch:

jobs:
  check-expiring-memberships:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Check expiring memberships
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
        run: |
          python << 'EOF'
          import os
          from datetime import datetime, timedelta
          from supabase import create_client, Client
          import requests
          
          SUPABASE_URL = os.environ.get("SUPABASE_URL")
          SUPABASE_KEY = os.environ.get("SUPABASE_SERVICE_ROLE_KEY")
          LINE_TOKEN = os.environ.get("LINE_CHANNEL_ACCESS_TOKEN")
          
          supabase = create_client(SUPABASE_URL, SUPABASE_KEY)
          
          print("ğŸ”” é–‹å§‹æª¢æŸ¥å³å°‡åˆ°æœŸçš„æœƒå“¡...")
          
          try:
              today = datetime.utcnow()
              
              # æª¢æŸ¥ 7 å¤©å…§åˆ°æœŸçš„æœƒå“¡
              seven_days_later = today + timedelta(days=7)
              
              response = supabase.table("profiles").select(
                  "id, email, membership_tier, expires_at, line_user_id, line_id"
              ).eq(
                  "membership_type", "lender"
              ).eq(
                  "payment_verified", "YES"
              ).not_.is_(
                  "expires_at", "null"
              ).lte(
                  "expires_at", seven_days_later.isoformat()
              ).gte(
                  "expires_at", today.isoformat()
              ).execute()
              
              expiring_members = response.data if response.data else []
              
              print(f"ğŸ“‹ æ‰¾åˆ° {len(expiring_members)} å€‹å³å°‡åˆ°æœŸçš„é‡‘ä¸»æœƒå“¡")
              
              if not expiring_members:
                  print("âœ… æ²’æœ‰å³å°‡åˆ°æœŸçš„æœƒå“¡")
                  exit(0)
              
              # ç™¼é€æé†’çµ¦æ¯å€‹å³å°‡åˆ°æœŸçš„æœƒå“¡
              reminded_count = 0
              for member in expiring_members:
                  member_id = member["id"]
                  email = member.get("email", "æœªçŸ¥")
                  tier = member.get("membership_tier", "æœªçŸ¥")
                  expires_at = datetime.fromisoformat(member["expires_at"].replace("Z", "+00:00"))
                  days_left = (expires_at - today).days
                  
                  line_id = member.get("line_user_id") or member.get("line_id")
                  
                  tier_names = {
                      "flagship": "æ——è‰¦æœƒå“¡",
                      "prestige": "å°Šæ¦®æœƒå“¡", 
                      "platinum": "é‰‘é‡‘æœƒå“¡"
                  }
                  tier_name = tier_names.get(tier, tier)
                  
                  print(f"\næœƒå“¡: {email}")
                  print(f"  ç­‰ç´š: {tier_name}")
                  print(f"  å‰©é¤˜å¤©æ•¸: {days_left} å¤©")
                  print(f"  åˆ°æœŸæ—¥: {expires_at.strftime('%Y-%m-%d')}")
                  
                  # å¦‚æœæœ‰ LINE IDï¼Œç™¼é€ LINE é€šçŸ¥
                  if line_id and LINE_TOKEN:
                      try:
                          message = {
                              "to": line_id,
                              "messages": [{
                                  "type": "text",
                                  "text": f"ã€å®‰å¿ƒå€Ÿè²¸ç¶² | æœƒå“¡åˆ°æœŸæé†’ã€‘\n\næ‚¨çš„{tier_name}å³å°‡æ–¼ {days_left} å¤©å¾Œåˆ°æœŸã€‚\n\nåˆ°æœŸæ—¥ï¼š{expires_at.strftime('%Yå¹´%mæœˆ%dæ—¥')}\n\nå¦‚éœ€ç¹¼çºŒäº«å—é‡‘ä¸»æœƒå“¡æœå‹™ï¼Œè«‹å„˜å¿«çºŒç´„ã€‚\n\næ„Ÿè¬æ‚¨çš„æ”¯æŒï¼"
                              }]
                          }
                          
                          headers = {
                              "Authorization": f"Bearer {LINE_TOKEN}",
                              "Content-Type": "application/json"
                          }
                          
                          response = requests.post(
                              "https://api.line.me/v2/bot/message/push",
                              json=message,
                              headers=headers,
                              timeout=10
                          )
                          
                          if response.status_code == 200:
                              print(f"  âœ… LINE æé†’å·²ç™¼é€")
                              reminded_count += 1
                          else:
                              print(f"  âš ï¸  LINE æé†’ç™¼é€å¤±æ•—: {response.status_code}")
                      except Exception as e:
                          print(f"  âš ï¸  LINE æé†’ç™¼é€å¤±æ•—: {e}")
                  else:
                      print(f"  âš ï¸  ç„¡ LINE ID æˆ– LINE Tokenï¼Œè·³é")
              
              # ä¿å­˜çµ±è¨ˆæ•¸æ“š
              with open("/tmp/expiration_stats.txt", "w", encoding="utf-8") as f:
                  f.write(f"{len(expiring_members)},{reminded_count}")
              
              print(f"\nâœ… ä»»å‹™å®Œæˆ! ç™¼é€äº† {reminded_count} å€‹æé†’")
              
          except Exception as e:
              print(f"âŒ éŒ¯èª¤: {e}")
              exit(1)
          EOF
      
      - name: Send summary email
        if: always()
        env:
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}
        run: |
          python << 'EOF'
          import os
          import smtplib
          from email.mime.text import MIMEText
          from email.mime.multipart import MIMEMultipart
          from datetime import datetime
          
          try:
              smtp_user = os.environ.get("SMTP_USERNAME")
              smtp_pass = os.environ.get("SMTP_PASSWORD")
              alert_email = os.environ.get("ALERT_EMAIL", "aijinetwork@gmail.com")
              
              if not smtp_user or not smtp_pass:
                  print("âš ï¸  éƒµä»¶é…ç½®æœªè¨­ç½®ï¼Œè·³éç™¼é€å ±å‘Š")
                  exit(0)
              
              # è®€å–çµ±è¨ˆæ•¸æ“š
              try:
                  with open("/tmp/expiration_stats.txt", "r") as f:
                      data = f.read().strip().split(",")
                      expiring_count, reminded_count = data
              except:
                  expiring_count, reminded_count = "0", "0"
              
              if int(expiring_count) > 0:
                  msg = MIMEMultipart()
                  msg['Subject'] = '[Money-Game] æœƒå“¡åˆ°æœŸæé†’å ±å‘Š'
                  msg['From'] = smtp_user
                  msg['To'] = alert_email
                  
                  body = f"""
ã€Money-Game æœƒå“¡åˆ°æœŸæé†’å ±å‘Šã€‘

åŸ·è¡Œæ™‚é–“ï¼š{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

å³å°‡åˆ°æœŸæœƒå“¡æ•¸ï¼š{expiring_count}
æˆåŠŸç™¼é€æé†’ï¼š{reminded_count}

è«‹é—œæ³¨æœƒå“¡çºŒç´„æƒ…æ³ã€‚

---
Money-Game è‡ªå‹•åŒ–ç³»çµ±
                  """
                  
                  msg.attach(MIMEText(body, 'plain', 'utf-8'))
                  
                  with smtplib.SMTP_SSL('smtp.gmail.com', 465) as server:
                      server.login(smtp_user, smtp_pass)
                      server.send_message(msg)
                  
                  print("âœ… åˆ°æœŸæé†’å ±å‘Šå·²ç™¼é€")
              else:
                  print("âœ… ç„¡å³å°‡åˆ°æœŸçš„æœƒå“¡ï¼Œç„¡éœ€ç™¼é€å ±å‘Š")
          except Exception as e:
              print(f"âš ï¸  ç™¼é€å ±å‘Šå¤±æ•—: {e}")
          EOF
