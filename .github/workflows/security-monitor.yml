name: Security Monitor

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  security-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Check website security
        id: security_check
        run: |
          python << 'EOF'
          import requests
          import ssl
          import socket
          from datetime import datetime
          from urllib.parse import urlparse
          
          WEBSITE_URL = "https://axnihao.com"
          
          print(f"ğŸ”’ é–‹å§‹å®‰å…¨æª¢æŸ¥: {WEBSITE_URL}")
          print(f"æª¢æŸ¥æ™‚é–“: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
          
          issues = []
          
          # 1. ç¶²ç«™å¯ç”¨æ€§æª¢æŸ¥
          print("ã€1ã€‘ç¶²ç«™å¯ç”¨æ€§æª¢æŸ¥")
          try:
              response = requests.get(WEBSITE_URL, timeout=10, verify=True)
              status_code = response.status_code
              
              if status_code == 200:
                  print(f"  âœ… ç¶²ç«™æ­£å¸¸è¨ªå• (HTTP {status_code})")
              elif 300 <= status_code < 400:
                  print(f"  âš ï¸  ç¶²ç«™é‡å®šå‘ (HTTP {status_code})")
              else:
                  print(f"  âŒ ç¶²ç«™ç•°å¸¸ (HTTP {status_code})")
                  issues.append(f"HTTPç‹€æ…‹ç¢¼ç•°å¸¸: {status_code}")
                  
              # æª¢æŸ¥éŸ¿æ‡‰æ™‚é–“
              response_time = response.elapsed.total_seconds()
              if response_time > 3:
                  print(f"  âš ï¸  éŸ¿æ‡‰æ™‚é–“è¼ƒæ…¢: {response_time:.2f}ç§’")
                  issues.append(f"éŸ¿æ‡‰æ™‚é–“éé•·: {response_time:.2f}ç§’")
              else:
                  print(f"  âœ… éŸ¿æ‡‰æ™‚é–“æ­£å¸¸: {response_time:.2f}ç§’")
                  
          except requests.exceptions.Timeout:
              print("  âŒ é€£æ¥è¶…æ™‚")
              issues.append("ç¶²ç«™é€£æ¥è¶…æ™‚")
          except requests.exceptions.ConnectionError:
              print("  âŒ é€£æ¥å¤±æ•—")
              issues.append("ç„¡æ³•é€£æ¥åˆ°ç¶²ç«™")
          except Exception as e:
              print(f"  âŒ æª¢æŸ¥å¤±æ•—: {e}")
              issues.append(f"å¯ç”¨æ€§æª¢æŸ¥å¤±æ•—: {e}")
          
          print()
          
          # 2. SSL è­‰æ›¸æª¢æŸ¥
          print("ã€2ã€‘SSL è­‰æ›¸æª¢æŸ¥")
          try:
              hostname = urlparse(WEBSITE_URL).netloc
              context = ssl.create_default_context()
              
              with socket.create_connection((hostname, 443), timeout=10) as sock:
                  with context.wrap_socket(sock, server_hostname=hostname) as ssock:
                      cert = ssock.getpeercert()
                      
                      # æª¢æŸ¥è­‰æ›¸æœ‰æ•ˆæœŸ
                      not_after = datetime.strptime(cert['notAfter'], '%b %d %H:%M:%S %Y %Z')
                      days_until_expiry = (not_after - datetime.now()).days
                      
                      if days_until_expiry < 0:
                          print(f"  âŒ SSL è­‰æ›¸å·²éæœŸ")
                          issues.append("SSLè­‰æ›¸å·²éæœŸ")
                      elif days_until_expiry < 30:
                          print(f"  âš ï¸  SSL è­‰æ›¸å³å°‡éæœŸ (å‰©é¤˜ {days_until_expiry} å¤©)")
                          issues.append(f"SSLè­‰æ›¸å³å°‡éæœŸ: å‰©é¤˜{days_until_expiry}å¤©")
                      else:
                          print(f"  âœ… SSL è­‰æ›¸æœ‰æ•ˆ (å‰©é¤˜ {days_until_expiry} å¤©)")
                      
                      print(f"  âœ… SSL é€£æ¥æ­£å¸¸")
                      
          except ssl.SSLError as e:
              print(f"  âŒ SSL éŒ¯èª¤: {e}")
              issues.append(f"SSLéŒ¯èª¤: {e}")
          except Exception as e:
              print(f"  âš ï¸  SSL æª¢æŸ¥å¤±æ•—: {e}")
          
          print()
          
          # 3. å…§å®¹ç•°å¸¸æª¢æŸ¥
          print("ã€3ã€‘å…§å®¹ç•°å¸¸æª¢æŸ¥")
          try:
              response = requests.get(WEBSITE_URL, timeout=10)
              content = response.text.lower()
              
              # æª¢æŸ¥å¸¸è¦‹çš„éŒ¯èª¤é—œéµè©
              error_keywords = {
                  "sql error": "SQLéŒ¯èª¤",
                  "database error": "æ•¸æ“šåº«éŒ¯èª¤",
                  "fatal error": "è‡´å‘½éŒ¯èª¤",
                  "warning:": "PHPè­¦å‘Š",
                  "notice:": "PHPæç¤º",
                  "syntax error": "èªæ³•éŒ¯èª¤",
                  "connection failed": "é€£æ¥å¤±æ•—",
                  "access denied": "è¨ªå•è¢«æ‹’",
              }
              
              found_issues = []
              for keyword, description in error_keywords.items():
                  if keyword in content:
                      found_issues.append(description)
              
              if found_issues:
                  print(f"  âŒ æª¢æ¸¬åˆ°ç•°å¸¸å…§å®¹:")
                  for issue in found_issues:
                      print(f"     - {issue}")
                      issues.append(f"å…§å®¹ç•°å¸¸: {issue}")
              else:
                  print(f"  âœ… æœªæª¢æ¸¬åˆ°ç•°å¸¸å…§å®¹")
                  
          except Exception as e:
              print(f"  âš ï¸  å…§å®¹æª¢æŸ¥å¤±æ•—: {e}")
          
          print()
          
          # ç¸½çµ
          print("="*60)
          if not issues:
              print("ã€æª¢æŸ¥çµæœã€‘âœ… æ‰€æœ‰æª¢æŸ¥é€šéï¼Œç¶²ç«™é‹è¡Œæ­£å¸¸")
              with open("/tmp/security_status.txt", "w") as f:
                  f.write("OK")
          else:
              print(f"ã€æª¢æŸ¥çµæœã€‘âŒ ç™¼ç¾ {len(issues)} å€‹å•é¡Œ:")
              for i, issue in enumerate(issues, 1):
                  print(f"  {i}. {issue}")
              with open("/tmp/security_status.txt", "w") as f:
                  f.write("ISSUES")
              with open("/tmp/security_issues.txt", "w", encoding="utf-8") as f:
                  f.write("\n".join(issues))
          print("="*60)
          EOF
      
      - name: Send alert if issues found
        if: always()
        env:
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}
        run: |
          python << 'EOF'
          import os
          import smtplib
          from email.mime.text import MIMEText
          from email.mime.multipart import MIMEMultipart
          from datetime import datetime
          
          try:
              # æª¢æŸ¥æ˜¯å¦æœ‰å•é¡Œ
              with open("/tmp/security_status.txt", "r") as f:
                  status = f.read().strip()
              
              smtp_user = os.environ.get("SMTP_USERNAME")
              smtp_pass = os.environ.get("SMTP_PASSWORD")
              alert_email = os.environ.get("ALERT_EMAIL", "aijinetwork@gmail.com")
              
              if not smtp_user or not smtp_pass:
                  print("âš ï¸  éƒµä»¶é…ç½®æœªè¨­ç½®ï¼Œè·³éç™¼é€å‘Šè­¦")
                  exit(0)
              
              if status == "ISSUES":
                  # è®€å–å•é¡Œåˆ—è¡¨
                  with open("/tmp/security_issues.txt", "r", encoding="utf-8") as f:
                      issues = f.read()
                  
                  msg = MIMEMultipart()
                  msg['Subject'] = 'âš ï¸ [Money-Game] ç¶²ç«™å®‰å…¨è­¦å‘Š'
                  msg['From'] = smtp_user
                  msg['To'] = alert_email
                  
                  body = f"""
ã€Money-Game å®‰å…¨ç›£æ§å‘Šè­¦ã€‘

æª¢æŸ¥æ™‚é–“ï¼š{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
ç¶²ç«™åœ°å€ï¼šhttps://axnihao.com

âš ï¸  ç™¼ç¾ä»¥ä¸‹å®‰å…¨å•é¡Œï¼š

{issues}

{'='*60}

è«‹ç«‹å³æª¢æŸ¥ç¶²ç«™ç‹€æ…‹ä¸¦æ¡å–ç›¸æ‡‰æªæ–½ã€‚

---
Money-Game è‡ªå‹•åŒ–å®‰å…¨ç›£æ§ç³»çµ±
                  """
                  
                  msg.attach(MIMEText(body, 'plain', 'utf-8'))
                  
                  with smtplib.SMTP_SSL('smtp.gmail.com', 465) as server:
                      server.login(smtp_user, smtp_pass)
                      server.send_message(msg)
                  
                  print("âœ… å®‰å…¨å‘Šè­¦éƒµä»¶å·²ç™¼é€")
              else:
                  print("âœ… ç„¡éœ€ç™¼é€å‘Šè­¦ï¼Œç¶²ç«™é‹è¡Œæ­£å¸¸")
                  
          except FileNotFoundError:
              print("âš ï¸  æœªæ‰¾åˆ°å®‰å…¨æª¢æŸ¥çµæœæ–‡ä»¶")
          except Exception as e:
              print(f"âš ï¸  ç™¼é€å‘Šè­¦å¤±æ•—: {e}")
          EOF
