name: Weekly Member Report

on:
  schedule:
    # Every Monday at 8:00 AM UTC
    - cron: '0 8 * * 1'
  workflow_dispatch:

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Generate weekly report
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          python << 'EOF'
          import os
          from datetime import datetime, timedelta
          from supabase import create_client, Client
          
          SUPABASE_URL = os.environ.get("SUPABASE_URL")
          SUPABASE_KEY = os.environ.get("SUPABASE_SERVICE_ROLE_KEY")
          
          supabase = create_client(SUPABASE_URL, SUPABASE_KEY)
          
          print("ğŸ“Š é–‹å§‹ç”Ÿæˆå‘¨æœƒå“¡çµ±è¨ˆå ±å‘Š...")
          
          try:
              # è¨ˆç®—æœ¬å‘¨æ—¥æœŸç¯„åœï¼ˆé€±ä¸€åˆ°é€±æ—¥ï¼‰
              today = datetime.utcnow()
              # æ‰¾åˆ°æœ¬é€±ä¸€
              days_since_monday = today.weekday()
              week_start = (today - timedelta(days=days_since_monday)).replace(hour=0, minute=0, second=0, microsecond=0)
              week_end = week_start + timedelta(days=7)
              
              print(f"ğŸ“… å ±å‘Šé€±æœŸ: {week_start.strftime('%Y-%m-%d')} ~ {week_end.strftime('%Y-%m-%d')}")
              
              # 1. æœ¬é€±æ–°åŠ å…¥çš„å€Ÿæ¬¾äºº
              borrower_response = supabase.table("profiles").select(
                  "id, email, created_at"
              ).eq(
                  "membership_type", "borrower"
              ).gte(
                  "created_at", week_start.isoformat()
              ).lt(
                  "created_at", week_end.isoformat()
              ).execute()
              
              new_borrowers = len(borrower_response.data) if borrower_response.data else 0
              
              # 2. æœ¬é€±æ–°åŠ å…¥çš„é‡‘ä¸»
              lender_response = supabase.table("profiles").select(
                  "id, email, created_at"
              ).eq(
                  "membership_type", "lender"
              ).gte(
                  "created_at", week_start.isoformat()
              ).lt(
                  "created_at", week_end.isoformat()
              ).execute()
              
              new_lenders = len(lender_response.data) if lender_response.data else 0
              
              # 3. æœ¬é€±å·²æ¿€æ´»çš„é‡‘ä¸»
              activated_response = supabase.table("profiles").select(
                  "id, email, activated_at, membership_tier"
              ).eq(
                  "membership_type", "lender"
              ).eq(
                  "payment_verified", "YES"
              ).gte(
                  "activated_at", week_start.isoformat()
              ).lt(
                  "activated_at", week_end.isoformat()
              ).execute()
              
              activated_lenders = len(activated_response.data) if activated_response.data else 0
              
              # 4. å¾…æ¿€æ´»é‡‘ä¸»ï¼ˆå·²æ”¯ä»˜ä½†æœªæ¿€æ´»ï¼‰
              pending_response = supabase.table("profiles").select(
                  "id, email, payment_last_five_digits"
              ).eq(
                  "membership_type", "lender"
              ).eq(
                  "payment_verified", "NO"
              ).not_.is_(
                  "payment_last_five_digits", "null"
              ).execute()
              
              pending_lenders = len(pending_response.data) if pending_response.data else 0
              
              # 5. å¹³å°ç¸½æœƒå“¡æ•¸
              all_members_response = supabase.table("profiles").select("id").execute()
              total_members = len(all_members_response.data) if all_members_response.data else 0
              
              # 6. è¨ˆç®—æ¿€æ´»ç‡
              activation_rate = (activated_lenders / new_lenders * 100) if new_lenders > 0 else 0
              
              # è¼¸å‡ºå ±å‘Š
              print("\n" + "="*60)
              print("ã€æœ¬é€±æ–°åŠ å…¥æœƒå“¡ã€‘")
              print(f"â”œâ”€ å€Ÿæ¬¾äºº(Borrower): {new_borrowers} ä½")
              print(f"â””â”€ é‡‘ä¸»(Lender): {new_lenders} ä½")
              print()
              print("ã€é‡‘ä¸»æœƒå“¡æ¿€æ´»æƒ…æ³ã€‘")
              print(f"â”œâ”€ å·²æ¿€æ´»é‡‘ä¸»: {activated_lenders} ä½")
              print(f"â”œâ”€ å¾…æ¿€æ´»é‡‘ä¸»: {pending_lenders} ä½")
              print(f"â””â”€ æ¿€æ´»ç‡: {activation_rate:.1f}%")
              print()
              print("ã€å¹³å°æ•´é«”æ•¸æ“šã€‘")
              print(f"â”œâ”€ å¹³å°ç¸½æœƒå“¡æ•¸: {total_members} ä½")
              print(f"â””â”€ å ±å‘Šé€±æœŸ: {week_start.strftime('%Y-%m-%d')} ~ {week_end.strftime('%Y-%m-%d')}")
              print()
              print("ã€ç³»çµ±ç‹€æ…‹ã€‘")
              print("â””â”€ âœ… ç³»çµ±é‹è¡Œæ­£å¸¸")
              print("="*60)
              
              # ä¿å­˜å ±å‘Šæ•¸æ“šä¾›éƒµä»¶ä½¿ç”¨
              with open("/tmp/report_data.txt", "w", encoding="utf-8") as f:
                  f.write(f"{new_borrowers},{new_lenders},{activated_lenders},{pending_lenders},{total_members},{activation_rate:.1f},{week_start.strftime('%Y-%m-%d')},{week_end.strftime('%Y-%m-%d')}")
              
              print("\nâœ… å ±å‘Šç”Ÿæˆå®Œæˆ!")
              
          except Exception as e:
              print(f"âŒ éŒ¯èª¤: {e}")
              exit(1)
          EOF
      
      - name: Send weekly report email
        env:
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}
        run: |
          python << 'EOF'
          import os
          import smtplib
          from email.mime.text import MIMEText
          from email.mime.multipart import MIMEMultipart
          from datetime import datetime
          
          try:
              smtp_user = os.environ.get("SMTP_USERNAME")
              smtp_pass = os.environ.get("SMTP_PASSWORD")
              alert_email = os.environ.get("ALERT_EMAIL", "aijinetwork@gmail.com")
              
              if not smtp_user or not smtp_pass:
                  print("âš ï¸  éƒµä»¶é…ç½®æœªè¨­ç½®ï¼Œè·³éç™¼é€å ±å‘Š")
                  exit(0)
              
              # è®€å–å ±å‘Šæ•¸æ“š
              with open("/tmp/report_data.txt", "r", encoding="utf-8") as f:
                  data = f.read().strip().split(",")
                  new_borrowers, new_lenders, activated_lenders, pending_lenders, total_members, activation_rate, week_start, week_end = data
              
              msg = MIMEMultipart()
              msg['Subject'] = '[Money-Game] å‘¨æœƒå“¡çµ±è¨ˆå ±å‘Š'
              msg['From'] = smtp_user
              msg['To'] = alert_email
              
              body = f"""
ã€Money-Game å‘¨æœƒå“¡çµ±è¨ˆå ±å‘Šã€‘

ç”Ÿæˆæ™‚é–“ï¼š{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

{'='*60}

ã€æœ¬é€±æ–°åŠ å…¥æœƒå“¡ã€‘
â”œâ”€ å€Ÿæ¬¾äºº(Borrower): {new_borrowers} ä½
â””â”€ é‡‘ä¸»(Lender): {new_lenders} ä½

ã€é‡‘ä¸»æœƒå“¡æ¿€æ´»æƒ…æ³ã€‘
â”œâ”€ å·²æ¿€æ´»é‡‘ä¸»: {activated_lenders} ä½
â”œâ”€ å¾…æ¿€æ´»é‡‘ä¸»: {pending_lenders} ä½
â””â”€ æ¿€æ´»ç‡: {activation_rate}%

ã€å¹³å°æ•´é«”æ•¸æ“šã€‘
â”œâ”€ å¹³å°ç¸½æœƒå“¡æ•¸: {total_members} ä½
â””â”€ å ±å‘Šé€±æœŸ: {week_start} ~ {week_end}

ã€ç³»çµ±ç‹€æ…‹ã€‘
â””â”€ âœ… ç³»çµ±é‹è¡Œæ­£å¸¸

{'='*60}

---
Money-Game è‡ªå‹•åŒ–ç³»çµ±
https://axnihao.com
              """
              
              msg.attach(MIMEText(body, 'plain', 'utf-8'))
              
              with smtplib.SMTP_SSL('smtp.gmail.com', 465) as server:
                  server.login(smtp_user, smtp_pass)
                  server.send_message(msg)
              
              print("âœ… å‘¨å ±å‘Šéƒµä»¶å·²ç™¼é€")
          except Exception as e:
              print(f"âš ï¸  ç™¼é€å ±å‘Šå¤±æ•—: {e}")
          EOF
